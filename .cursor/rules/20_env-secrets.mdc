# Environment Variables & Secrets Management

## Environment Variable Standards

### Variable Naming Conventions
- **UPPER_SNAKE_CASE**: All environment variables use uppercase with underscores
- **Descriptive Names**: Clear, unambiguous variable names
- **Prefix Convention**: Use consistent prefixes for related variables
- **No Abbreviations**: Avoid abbreviations that could be unclear

```bash
# ✅ Good: Clear, descriptive naming
NEXT_PUBLIC_SUPABASE_URL=https://project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
STRIPE_SECRET_KEY=sk_test_51234567890abcdef...
STRIPE_WEBHOOK_SECRET=whsec_1234567890abcdef...

# ❌ Bad: Unclear or abbreviated names
SUPABASE_URL=https://project.supabase.co
STRIPE_KEY=sk_test_51234567890abcdef...
WEBHOOK=whsec_1234567890abcdef...
```

### Environment File Structure
```bash
# .env.example - Template for required variables
# Copy this file to .env.local and fill in your values

# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key

# Stripe Configuration
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key

# Application Configuration
COACHING_SCHEDULER_URL=your_coaching_scheduler_url

# Optional: Development/Testing
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### Environment Validation
```typescript
// lib/env.ts - Environment variable validation
import { z } from 'zod';

const envSchema = z.object({
  // Supabase
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  
  // Stripe
  STRIPE_SECRET_KEY: z.string().min(1),
  STRIPE_WEBHOOK_SECRET: z.string().min(1),
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().min(1),
  
  // Application
  COACHING_SCHEDULER_URL: z.string().url(),
  
  // Optional
  NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
  NEXT_PUBLIC_APP_URL: z.string().url().default('http://localhost:3000'),
});

export const env = envSchema.parse(process.env);

// Type-safe environment variables
export type Env = z.infer<typeof envSchema>;
```

## Secrets Management

### Client-Side vs Server-Side
```typescript
// ✅ Good: Client-side variables (safe to expose)
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const stripePublishableKey = process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY;

// ✅ Good: Server-side variables (never expose)
const stripeSecretKey = process.env.STRIPE_SECRET_KEY; // Only in API routes
const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET; // Only in API routes

// ❌ Bad: Never expose secrets to client
// const secretKey = process.env.STRIPE_SECRET_KEY; // In client component
```

### API Route Security
```typescript
// app/api/stripe/webhook/route.ts
import { env } from '@/lib/env';

export async function POST(request: Request) {
  // ✅ Good: Server-side only access to secrets
  const stripe = new Stripe(env.STRIPE_SECRET_KEY, {
    apiVersion: '2023-10-16',
  });
  
  const payload = await request.text();
  const signature = request.headers.get('stripe-signature')!;
  
  let event: Stripe.Event;
  try {
    event = stripe.webhooks.constructEvent(
      payload,
      signature,
      env.STRIPE_WEBHOOK_SECRET
    );
  } catch (err) {
    console.error('Webhook signature verification failed:', err);
    return new Response('Webhook signature verification failed', { status: 400 });
  }
  
  // Process webhook event
  return new Response('Webhook processed', { status: 200 });
}
```

## Development Environment Setup

### Local Development
```bash
# 1. Copy environment template
cp .env.example .env.local

# 2. Fill in required values
# Edit .env.local with your actual values

# 3. Verify environment variables
npm run env:check

# 4. Start development server
npm run dev
```

### Environment Validation Script
```typescript
// scripts/check-env.ts
import { envSchema } from '@/lib/env';

function checkEnvironment() {
  try {
    envSchema.parse(process.env);
    console.log('✅ All required environment variables are set');
    return true;
  } catch (error) {
    console.error('❌ Missing or invalid environment variables:');
    console.error(error);
    return false;
  }
}

if (require.main === module) {
  const isValid = checkEnvironment();
  process.exit(isValid ? 0 : 1);
}
```

## Production Environment

### Vercel Deployment
```bash
# Set environment variables in Vercel dashboard or CLI
vercel env add NEXT_PUBLIC_SUPABASE_URL
vercel env add NEXT_PUBLIC_SUPABASE_ANON_KEY
vercel env add STRIPE_SECRET_KEY
vercel env add STRIPE_WEBHOOK_SECRET
vercel env add NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
vercel env add COACHING_SCHEDULER_URL

# Verify environment variables
vercel env ls
```

### Environment Variable Documentation
```markdown
## Environment Variables

### Required Variables

#### Supabase Configuration
- `NEXT_PUBLIC_SUPABASE_URL`: Your Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Your Supabase anonymous key

#### Stripe Configuration
- `STRIPE_SECRET_KEY`: Your Stripe secret key (server-side only)
- `STRIPE_WEBHOOK_SECRET`: Your Stripe webhook endpoint secret
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`: Your Stripe publishable key

#### Application Configuration
- `COACHING_SCHEDULER_URL`: URL for coaching scheduler integration

### Optional Variables
- `NODE_ENV`: Environment mode (development/production/test)
- `NEXT_PUBLIC_APP_URL`: Application URL for development

### Security Notes
- Never commit `.env.local` or `.env` files to version control
- Use `NEXT_PUBLIC_` prefix only for variables that are safe to expose to the client
- Server-side secrets should never be accessible from the browser
```

## Testing Environment

### Test Environment Setup
```typescript
// __tests__/setup.ts
import { config } from 'dotenv';

// Load test environment variables
config({ path: '.env.test' });

// Mock environment variables for testing
process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';
process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY = 'test-anon-key';
process.env.STRIPE_SECRET_KEY = 'sk_test_mock';
process.env.STRIPE_WEBHOOK_SECRET = 'whsec_test_mock';
```

### Test Environment Variables
```bash
# .env.test - Test environment variables
NEXT_PUBLIC_SUPABASE_URL=https://test.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=test_anon_key
STRIPE_SECRET_KEY=sk_test_mock_key
STRIPE_WEBHOOK_SECRET=whsec_test_mock
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_mock
COACHING_SCHEDULER_URL=https://test-scheduler.com
NODE_ENV=test
```

## Security Best Practices

### Secrets Rotation
- **Regular Rotation**: Rotate API keys quarterly
- **Emergency Rotation**: Immediate rotation if compromised
- **Documentation**: Track rotation dates and procedures
- **Testing**: Verify functionality after rotation

### Access Control
```typescript
// ✅ Good: Environment-based access control
const isDevelopment = process.env.NODE_ENV === 'development';
const isProduction = process.env.NODE_ENV === 'production';

// Only allow certain features in development
if (isDevelopment) {
  console.log('Debug mode enabled');
}

// Enforce stricter security in production
if (isProduction) {
  // Additional security checks
  enforceStrictCORS();
  enableRateLimiting();
}
```

### Audit Trail
```typescript
// lib/audit.ts - Environment variable usage tracking
export function logEnvironmentAccess(variable: string, context: string) {
  if (process.env.NODE_ENV === 'production') {
    console.log(`Environment variable accessed: ${variable} in ${context}`);
  }
}

// Usage
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
logEnvironmentAccess('NEXT_PUBLIC_SUPABASE_URL', 'SupabaseClient');
```

## Troubleshooting

### Common Issues
```bash
# Issue: Environment variables not loading
# Solution: Check file naming and location
ls -la .env*

# Issue: Client-side access to server secrets
# Solution: Ensure no NEXT_PUBLIC_ prefix on secrets
grep -r "NEXT_PUBLIC_STRIPE_SECRET" src/

# Issue: Environment validation failing
# Solution: Run validation script
npm run env:check
```

### Debug Scripts
```typescript
// scripts/debug-env.ts
function debugEnvironment() {
  console.log('Environment Variables Debug:');
  console.log('NODE_ENV:', process.env.NODE_ENV);
  console.log('Available env vars:');
  
  Object.keys(process.env)
    .filter(key => key.startsWith('NEXT_PUBLIC_') || key.includes('STRIPE') || key.includes('SUPABASE'))
    .forEach(key => {
      const value = process.env[key];
      const masked = key.includes('SECRET') || key.includes('KEY') 
        ? value?.substring(0, 8) + '...' 
        : value;
      console.log(`  ${key}: ${masked}`);
    });
}

if (require.main === module) {
  debugEnvironment();
}
```

## Quality Checklist

### Environment Setup Checklist
- [ ] `.env.example` file exists with all required variables
- [ ] Environment validation schema is implemented
- [ ] Client-side variables use `NEXT_PUBLIC_` prefix
- [ ] Server-side secrets are never exposed to client
- [ ] Test environment variables are configured
- [ ] Production environment variables are set in deployment platform
- [ ] Documentation includes all environment variables
- [ ] Environment variable access is logged in production
- [ ] Secrets rotation procedure is documented
- [ ] Emergency access procedures are established
