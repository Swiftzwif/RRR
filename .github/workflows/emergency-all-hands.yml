name: Emergency All-Hands Response

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number for emergency'
        required: true
        type: number
      severity:
        description: 'Severity level'
        required: true
        default: 'high'
        type: choice
        options:
          - critical
          - high
          - medium

# Security: Restrict workflow permissions
permissions:
  contents: read
  issues: write
  pull-requests: read
  actions: read

jobs:
  emergency-response:
    if: |
      (github.event_name == 'issues' && 
       contains(github.event.label.name, 'emergency') &&
       github.event.sender.type != 'Bot' &&
       (github.event.sender.type == 'User' || github.event.sender.type == 'Organization')) ||
      (github.event_name == 'issue_comment' && 
       contains(github.event.comment.body, '/emergency') &&
       github.event.comment.author_association != 'NONE') ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          cd .github/ai-team
          pip install -r requirements.txt
      
      - name: Identify Emergency Context
        id: context
        run: |
          set -euo pipefail  # Exit on error, undefined vars, pipe failures
          
          # Determine issue number and context
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUMBER=${{ github.event.inputs.issue_number }}
            SEVERITY=${{ github.event.inputs.severity }}
            
            # Validate inputs
            if [ -z "$ISSUE_NUMBER" ] || ! [[ "$ISSUE_NUMBER" =~ ^[0-9]+$ ]]; then
              echo "Error: Invalid issue number: $ISSUE_NUMBER"
              exit 1
            fi
            
            if [ -z "$SEVERITY" ] || ! [[ "$SEVERITY" =~ ^(critical|high|medium)$ ]]; then
              echo "Error: Invalid severity level: $SEVERITY (must be critical, high, or medium)"
              exit 1
            fi
            
            # Validate issue exists
            if ! gh issue view $ISSUE_NUMBER > /dev/null 2>&1; then
              echo "Error: Issue #$ISSUE_NUMBER not found or inaccessible"
              exit 1
            fi
          elif [ "${{ github.event_name }}" == "issues" ]; then
            ISSUE_NUMBER=${{ github.event.issue.number }}
            SEVERITY="high"
          else
            ISSUE_NUMBER=${{ github.event.issue.number }}
            SEVERITY="high"
          fi
          
          echo "ISSUE_NUMBER=$ISSUE_NUMBER" >> $GITHUB_ENV
          echo "SEVERITY=$SEVERITY" >> $GITHUB_ENV
          
          # Get issue details
          gh issue view $ISSUE_NUMBER --json title,body,author,labels,createdAt,comments > emergency-context.json
          
          # Extract emergency information
          TITLE=$(jq -r '.title' emergency-context.json)
          BODY=$(jq -r '.body // "No description provided"' emergency-context.json)
          AUTHOR=$(jq -r '.author.login' emergency-context.json)
          
          echo "## Emergency Context" > emergency-data.txt
          echo "**Issue #$ISSUE_NUMBER:** $TITLE" >> emergency-data.txt
          echo "**Reported by:** @$AUTHOR" >> emergency-data.txt
          echo "**Severity:** $SEVERITY" >> emergency-data.txt
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> emergency-data.txt
          echo "" >> emergency-data.txt
          echo "**Description:**" >> emergency-data.txt
          echo "$BODY" >> emergency-data.txt
          echo "" >> emergency-data.txt
          
          # Get related context
          echo "**Recent Activity:**" >> emergency-data.txt
          
          # Recent commits that might be related
          echo "- Recent commits:" >> emergency-data.txt
          gh api repos/${{ github.repository }}/commits?per_page=5 --jq '.[] | "  - \(.sha[0:7]) \(.commit.message | split("\n")[0]) by @\(.author.login // .commit.author.name)"' >> emergency-data.txt
          
          # Recent deployments
          echo "- Recent deployments:" >> emergency-data.txt
          gh api repos/${{ github.repository }}/deployments?per_page=3 --jq '.[] | "  - \(.environment) at \(.created_at) (\(.ref))"' >> emergency-data.txt 2>/dev/null || echo "  - No deployment data available" >> emergency-data.txt
          
          # System status checks
          echo "" >> emergency-data.txt
          echo "**System Status:**" >> emergency-data.txt
          # This would integrate with monitoring tools in a real setup
          echo "- API Status: [Monitoring integration needed]" >> emergency-data.txt
          echo "- Database Status: [Monitoring integration needed]" >> emergency-data.txt
          echo "- Service Health: [Monitoring integration needed]" >> emergency-data.txt
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: All-Hands AI Analysis
        id: analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          cd .github/ai-team
          
          # Create multi-bot analysis prompt
          PROMPT=$(cat <<'EOF'
          This is an EMERGENCY requiring immediate all-hands response. All AI team members must analyze and provide their perspective.
          
          Emergency Context:
          $(cat ../emergency-data.txt)
          
          Each bot provides their analysis:
          
          # ðŸš¨ EMERGENCY ALL-HANDS RESPONSE
          
          ## ðŸŽ¯ CEO Bot - Strategic Assessment
          [Business impact, stakeholder communication, strategic decisions needed]
          
          ## ðŸ’» CTO Bot - Technical Analysis
          [Root cause analysis, technical solution, implementation plan]
          
          ## ðŸ’° CFO Bot - Financial Impact
          [Cost implications, resource allocation, financial risk]
          
          ## ðŸ”§ COO Bot - Operational Response
          [Immediate actions, team coordination, process changes]
          
          ## ðŸ“‹ PRD Bot - Requirements Analysis
          [What needs to be built/fixed, acceptance criteria, scope definition]
          
          ## ðŸ§ª QA Bot - Quality Assessment
          [Testing requirements, regression risks, validation plan]
          
          ## ðŸ”’ Security Bot - Security Analysis
          [Security implications, vulnerabilities, compliance impact]
          
          ## ðŸš€ DevOps Bot - Infrastructure Response
          [Deployment strategy, rollback options, monitoring needs]
          
          ## ðŸ“Š Immediate Action Plan
          1. **[0-15 minutes]**: [Critical immediate actions]
          2. **[15-60 minutes]**: [Short-term fixes]
          3. **[1-4 hours]**: [Medium-term solutions]
          4. **[4-24 hours]**: [Long-term fixes]
          
          ## ðŸŽ¯ Success Criteria
          [How we know the emergency is resolved]
          
          ## ðŸ“ž Communication Plan
          - **Internal**: [Team communication strategy]
          - **External**: [Customer communication if needed]
          
          ## ðŸ”„ Post-Mortem Requirements
          [What we need to investigate after resolution]
          
          Remember: This is an emergency. Be concise, actionable, and focus on immediate resolution while considering long-term implications.
          EOF
          )
          
          # Use high priority for emergency (secrets are now in env block, not inline)
          RESPONSE=$(python scripts/ai_api_handler.py "coo_bot" "$PROMPT" "high")
          
          echo "$RESPONSE" > emergency-response.md
      
      - name: Create Emergency Response
        run: |
          cd .github/ai-team
          
          # Create comprehensive response
          {
            echo "# ðŸš¨ EMERGENCY ALL-HANDS RESPONSE"
            echo ""
            echo "**Status:** ðŸ”´ ACTIVE EMERGENCY"
            echo "**Incident #:** ${{ env.ISSUE_NUMBER }}"
            echo "**Severity:** ${{ env.SEVERITY }}"
            echo "**Response Time:** $(date -u '+%Y-%m-%d %H:%M UTC')"
            echo ""
            echo "---"
            echo ""
            cat emergency-response.md
            echo ""
            echo "---"
            echo ""
            echo "## ðŸŽ¬ Response Coordination"
            echo ""
            echo "**Incident Commander:** @${{ github.repository_owner }}"
            echo "**Response Team:** All AI Bots Active"
            echo ""
            echo "### ðŸ“± Real-Time Updates"
            echo "- Updates will be posted every 30 minutes"
            echo "- All team members are monitoring this issue"
            echo "- Use ðŸš¨ reaction to escalate further"
            echo ""
            echo "### ðŸ› ï¸ Quick Actions"
            echo "- Reply \`/status\` for current status"
            echo "- Reply \`/rollback\` to initiate rollback"
            echo "- Reply \`/escalate\` to notify additional team members"
            echo "- Reply \`/resolved\` when emergency is resolved"
            echo ""
            echo "---"
            echo ""
            echo "**ðŸ¤– All AI Team Bots are actively monitoring this emergency**"
          } > emergency-issue-response.md
          
          # Post the response
          gh issue comment ${{ env.ISSUE_NUMBER }} --body-file emergency-issue-response.md
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Update Issue Labels and Priority
        run: |
          # Add emergency labels
          gh issue edit ${{ env.ISSUE_NUMBER }} \
            --add-label "emergency,P0,all-hands,incident-active"
          
          # Add severity label
          gh issue edit ${{ env.ISSUE_NUMBER }} \
            --add-label "severity:${{ env.SEVERITY }}"
          
          # Pin the issue if possible
          # gh issue pin ${{ env.ISSUE_NUMBER }} 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Create Follow-up Tasks
        run: |
          cd .github/ai-team
          
          # Create a checklist comment for tracking
          {
            echo "## âœ… Emergency Response Checklist"
            echo ""
            echo "### Immediate (0-15 min)"
            echo "- [ ] Root cause identified"
            echo "- [ ] Immediate mitigation applied"
            echo "- [ ] Stakeholders notified"
            echo "- [ ] Monitoring increased"
            echo ""
            echo "### Short-term (15-60 min)"
            echo "- [ ] Temporary fix deployed"
            echo "- [ ] Tests written for issue"
            echo "- [ ] Documentation updated"
            echo ""
            echo "### Long-term (1-24 hours)"
            echo "- [ ] Permanent fix developed"
            echo "- [ ] Full test coverage"
            echo "- [ ] Post-mortem scheduled"
            echo ""
            echo "---"
            echo "*Update this checklist as items are completed*"
          } > checklist.md
          
          gh issue comment ${{ env.ISSUE_NUMBER }} --body-file checklist.md
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Trigger Related Workflows
        if: env.SEVERITY == 'critical'
        run: |
          # For critical emergencies, trigger additional responses
          
          # Notify via other channels (webhook placeholder)
          # curl -X POST ${{ secrets.EMERGENCY_WEBHOOK }} -d "{\"emergency\": ${{ env.ISSUE_NUMBER }}}"
          
          # Create high-priority PR if code fix needed
          # gh workflow run emergency-fix.yml -f issue=${{ env.ISSUE_NUMBER }}
          
          echo "::error::CRITICAL EMERGENCY #${{ env.ISSUE_NUMBER }} - All hands response activated"
          echo "::notice::Emergency response initiated. All bots are actively working on resolution."
